{"version":3,"sources":["predict_prostate/models/tests.cljs"],"mappings":";AAKA;;;0CAAA,kDAAAA,5FAAMI;AAAN,AAAA,IAAAH,aAAAD;IAAAC,iBAAA,AAAAC,4BAAAD;eAAA,AAAAE,4CAAAF,eAAA,tEAEWI;gBAFX,AAAAF,4CAAAF,eAAA,vEAEoBK;AAFpB,AAGE,IAAMC,sMAAY,AAACC,sDAAaH,rGACd,+GAAA,mEAAA,WAAAI,7LAACC,/CACD,AAACA,/CACD,AAACA,/CACD,AAACA;AAHD,AAAsB,mDAAAD,iBAAA,7DAACE;IACvB,mEAAA,WAAAC;AAAA,AAAsB,mDAAAA,iBAAA,7DAACD;IACvB,sEAAA,WAAAE;AAAA,AAAuB,mDAAAA,iBAAA,7DAACF;IACxB,sEAAA,WAAAG;AAAA,AAAuB,mDAAAA,iBAAA,7DAACH;;IACpCI,OAAK,AAACC,0DAAWC,8DAAEV,QAAQD;AALjC,AAMES;;AAEJ;;;+CAAA,/CAAMG,sGAEHC;AAFH,AAGE,IAAMC,gBAAc,kBAAA,WAAAC,7BAACC;AAAD,AAAU,OAACC,eAAK,WAAKC;AAAL,AAAQ,YAAA,JAAGA;GAAa,AAACC,eAAK,wCAAAJ,xCAACjB;GAAee;AAAlF,AACE,GACE,6CAAA,7CAACO,8EAAKN;AAAe,mBAAA,yBAAA,rCAACO,kBAAqB,AAACC,gBAAMT;;AADpD,AAEQ,mBAAA,wCAAA,pDAACQ,qBAAwB,AAACC,gBAAMR,sCAAsC,4CAAKA;;;;AAEvF,2CAAA,mDAAAS,9FAAME;AAAN,AAAA,IAAAD,aAAAD;IAAAC,iBAAA,AAAA5B,4BAAA4B;aAAA,AAAA3B,4CAAA2B,eAAA,pEAA0BE;kBAA1B,AAAA7B,4CAAA2B,eAAA,zEAAiCG;AAAjC,AACE,OAAMC,YAAW,CAAA,mEAAA,RAAoBF,wDAAWC;;AAElD;;;+CAAA,2DAAAE,1GAAME,sGAEHC;AAFH,AAAA,IAAAF,aAAAD;IAAAC,iBAAA,AAAAlC,4BAAAkC;cAAA,AAAAjC,4CAAAiC,eAAA,rEAEeG;AAFf,AAGE,gHAAA,2CAAA,gHAAA,mEAAA,0DAAA,0DAAA,2DAAA,2CAAA,gBAAA,jjBAACC,mDAAIF,wKAAoBP,oGACAQ;;AAK3B","names":["p__58543","map__58544","cljs.core/--destructure-map","cljs.core.get","predict-prostate.models.tests/clj-stata","stata-in","stata-out","clj-res","predict-prostate.models.prostate-release/run-prostate","p1__58539#","cljs.core.update","cljs.core.nth","p1__58540#","p1__58541#","p1__58542#","diff","cljs.core.merge_with","cljs.core/-","predict-prostate.models.tests/test-all-cases","c","failing-cases","p1__58545#","cljs.core/filterv","cljs.core/some","x","cljs.core/vals","cljs.core._EQ_","js/console.log","cljs.core/count","p__58546","map__58547","predict-prostate.models.tests/file-error","status","status-text","js/console","p__58548","map__58549","predict-prostate.models.tests/get-test-cases","url","handler","ajax.core.GET"],"sourcesContent":["(ns predict-prostate.models.tests\n  (:require [predict-prostate.models.prostate-release :refer [run-prostate]]\n            [ajax.core :refer [GET]]\n            [cljs.reader :as edn]))\n\n(defn clj-stata\n  \"Tests one case against the stata generated output\"\n  [{:keys [stata-in stata-out]}]\n  (let [clj-res (-> (run-prostate stata-in)\n                    (update :PCSsurvival #(nth % 0))\n                    (update :pred-PC-cum #(nth % 1))\n                    (update :pred-NPC-cum #(nth % 1))\n                    (update :NPC-survival #(nth % 1)))\n        diff (merge-with - clj-res stata-out)]\n    diff))\n\n(defn test-all-cases\n  \"Tests all cases and returns failing test cases\"\n  [c]\n  (let [failing-cases (filterv #(some (fn [x] (> x 0.000001)) (vals (clj-stata %))) c)]\n    (cond\n      (= [] failing-cases) (js/console.log \"All\" (count c) \"model tests are passing.\")\n      :else (js/console.log \"Some (\" (count failing-cases) \") tests are failing.\" (str failing-cases)))))\n\n(defn file-error [{:keys [status status-text]}]\n  (.log js/console (str \"file error: \" status \" \" status-text)))\n\n(defn get-test-cases\n  \"read test cases from a url.\"\n  [url {:keys [handler]}]\n  (GET url {:error-handler file-error                      ;on-error\n            :handler       handler\n            :format        :transit                        ;:transit\n            :headers {\"Cache-Control\" \"no-store\"}\n            }))\n\n(comment\n  (def cases\n    [{:stata-in {:age 57, :n 10, :psa 88.68037946090843, :biopsy-cores-involved 511758, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 1, :grade-group 5, :brca 1}, :stata-out {:PCSsurvival \".98674697\", :pred-PC-cum \".013230884\", :pred-NPC-cum \".0019078079\", :NPC-survival \".99808902\"}}\n     {:stata-in {:age 57, :n 15, :psa 98.6835926753496, :biopsy-cores-involved 833231, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 3, :grade-group 2, :brca 0}, :stata-out {:PCSsurvival \".99808168\", :pred-PC-cum \".001916465\", :pred-NPC-cum \".0019091695\", :NPC-survival \".99808902\"}}\n     {:stata-in {:age 45, :n 15, :psa 24.750293581194715, :biopsy-cores-involved 214505, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 3, :grade-group 1, :brca 1}, :stata-out {:PCSsurvival \".99901557\", :pred-PC-cum \".00098411122\", :pred-NPC-cum \".0004386965\", :NPC-survival \".99956119\"}}\n     {:stata-in {:age 59, :n 5, :psa 54.90078734695496, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 1, :grade-group 5, :brca 1}, :stata-out {:PCSsurvival \".98873144\", :pred-PC-cum \".011231656\", :pred-NPC-cum \".0046021445\", :NPC-survival \".99538273\"}}\n     {:stata-in {:age 67, :n 15, :psa 6.304467015092829, :biopsy-cores-involved 332829, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 3, :grade-group 5, :brca 1}, :stata-out {:PCSsurvival \".98712665\", :pred-PC-cum \".012792476\", :pred-NPC-cum \".012194422\", :NPC-survival \".98772848\"}}\n     {:stata-in {:age 49, :n 10, :psa 56.87237531381666, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 4, :grade-group 4, :brca 0}, :stata-out {:PCSsurvival \".99822879\", :pred-PC-cum \".0017702978\", :pred-NPC-cum \".00071633066\", :NPC-survival \".99928331\"}}\n     {:stata-in {:age 54, :n 5, :psa 18.72962680067738, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 2, :grade-group 5, :brca 0}, :stata-out {:PCSsurvival \".99628258\", :pred-PC-cum \".0037138155\", :pred-NPC-cum \".001321733\", :NPC-survival \".99867696\"}}\n     {:stata-in {:age 35, :n 5, :psa 78.68497321001044, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 4, :grade-group 4, :brca 1}, :stata-out {:PCSsurvival \".9920491\", :pred-PC-cum \".0079498654\", :pred-NPC-cum \".00012869922\", :NPC-survival \".99987131\"}}\n     {:stata-in {:age 81, :n 15, :psa 65.84819880840398, :biopsy-cores-involved 91944, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 1, :grade-group 4, :brca 0}, :stata-out {:PCSsurvival \".99706537\", :pred-PC-cum \".0029263659\", :pred-NPC-cum \".066272773\", :NPC-survival \".93354046\"}}\n     {:stata-in {:age 62, :n 15, :psa 81.03150548903464, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 3, :grade-group 3, :brca 1}, :stata-out {:PCSsurvival \".99562901\", :pred-PC-cum \".0043594576\", :pred-NPC-cum \".0066467952\", :NPC-survival \".9933356\"}}\n     {:stata-in {:age 46, :n 5, :psa 69.93799566212054, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 1, :grade-group 1, :brca 0}, :stata-out {:PCSsurvival \".99955821\", :pred-PC-cum \".00044167764\", :pred-NPC-cum \".00093864911\", :NPC-survival \".99906105\"}}\n     {:stata-in {:age 40, :n 5, :psa 62.131664527085604, :biopsy-cores-involved 725640, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 1, :grade-group 4, :brca 0}, :stata-out {:PCSsurvival \".99757951\", :pred-PC-cum \".002419583\", :pred-NPC-cum \".0004497089\", :NPC-survival \".9995501\"}}\n     {:stata-in {:age 86, :n 15, :psa 67.56349782999848, :biopsy-cores-involved 259742, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 4, :grade-group 1, :brca 0}, :stata-out {:PCSsurvival \".99741513\", :pred-PC-cum \".0025783379\", :pred-NPC-cum \".1189565\", :NPC-survival \".88074178\"}}\n     {:stata-in {:age 54, :n 10, :psa 19.035711350943373, :biopsy-cores-involved 743428, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 2, :grade-group 1, :brca 1}, :stata-out {:PCSsurvival \".99812967\", :pred-PC-cum \".0018683333\", :pred-NPC-cum \".002500416\", :NPC-survival \".9974969\"}}\n     {:stata-in {:age 56, :n 5, :psa 32.78588166426538, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 1, :grade-group 1, :brca 1}, :stata-out {:PCSsurvival \".99877328\", :pred-PC-cum \".0012258532\", :pred-NPC-cum \".0016893627\", :NPC-survival \".99830943\"}}\n     {:stata-in {:age 79, :n 15, :psa 86.59161029684923, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 4, :grade-group 2, :brca 1}, :stata-out {:PCSsurvival \".98363227\", :pred-PC-cum \".016163604\", :pred-NPC-cum \".051733959\", :NPC-survival \".9476127\"}}\n     {:stata-in {:age 53, :n 5, :psa 22.309582922176542, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 4, :grade-group 1, :brca 1}, :stata-out {:PCSsurvival \".9960202\", :pred-PC-cum \".0039741113\", :pred-NPC-cum \".0022113095\", :NPC-survival \".99778557\"}}\n     {:stata-in {:age 92, :n 15, :psa 98.31244913416086, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 2, :grade-group 1, :brca 1}, :stata-out {:PCSsurvival \".98338014\", :pred-PC-cum \".016362041\", :pred-NPC-cum \".22925976\", :NPC-survival \".76712775\"}}\n     {:stata-in {:age 75, :n 5, :psa 51.252430930559676, :biopsy-cores-involved 915855, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 3, :grade-group 4, :brca 0}, :stata-out {:PCSsurvival \".994578\", :pred-PC-cum \".0053996383\", :pred-NPC-cum \".017180255\", :NPC-survival \".98274857\"}}\n     {:stata-in {:age 72, :n 15, :psa 43.69854304631768, :biopsy-cores-involved 388573, :biopsy-done 1, :charlson-comorbidity 1, :biopsy-cores-taken 1000000, :primary-rx 1, :t-stage 1, :grade-group 5, :brca 0}, :stata-out {:PCSsurvival \".99688697\", :pred-PC-cum \".0031045307\", :pred-NPC-cum \".022480862\", :NPC-survival \".97745746\"}}\n     {:stata-in {:age 85, :n 5, :psa 77.33509541764772, :biopsy-cores-involved 419415, :biopsy-done 1, :charlson-comorbidity 0, :biopsy-cores-taken 1000000, :primary-rx 0, :t-stage 3, :grade-group 3, :brca 0}, :stata-out {:PCSsurvival \".99124891\", :pred-PC-cum \".0086846277\", :pred-NPC-cum \".057174005\", :NPC-survival \".9423883\"}}])\n\n  (clj-stata (nth cases 15))\n  (test-all-cases cases)\n  (get-test-cases \"/test-runs.txt\"\n                  {:handler #(println (edn/read-string %))}\n                  #_{:on-error #(put! err-chan %)\n                     :handler  #(put! static-chan %)})\n  ,)"]}